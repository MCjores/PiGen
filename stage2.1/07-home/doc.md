# Перенос домашней директории на отдельный раздел
Для обеспечения сохранности данных при аварийном выключении системы,
домашняя директория (/home) вынесена на отдельный раздел SD карты с
файловой системой BTRFS, реализующей принцип "Копирование при записи".
Таким образом, если при перезаписи файла системы будет выключена, то при
последующем включении файл будет содержать данные, предшествующие началу
записи. Для работы с данной файловой системой устанавливается пакет "btrfs-progs",
содержащий утилиты.

> [!NOTE]
> Для монтирования файловой системы BTRFS в Linux пакет "btrfs-progs"
> не требуется. Он устанавливается для обеспечения таких функций
> как форматирование разделов, поддержка операций создания снимков и т.д.

## Создание подразделов
Файловая система BTRFS вводит понятие подразделов. Как следует из документации,
для пользователя подразделы выглядят как обычные директории, но с точки зрения
администратора они дают дополнительные возможности. В данном дистрибутиве
в BTRFS разделе создаётся подраздел "@home" для размещения в нём домашней
директории "/home" и директория "snapshots" для хранения снимков "@home".

Общая структура SD карты имеет вид:

```
SD
├── boot          - Раздел fat32. Загрузчик и конфигурационные файлы (/boot)
├── rootfs        - Раздел ext4. Корень файловой системы (/)
└── btrfs         - Раздел btrfs.
    ├── @home     - Подраздел. Монтируется как домашняя директория (/home)
    └── snapshots - Директория для хранения снимков @home
```

## Добавление файловой системы
В файл "/etc/fstab" добавляется строка
```
HOMEDEV  /home  btrfs  rw,user,auto,exec,subvol=@home  0  0
```

## Разметка свободного пространства при первом включении
Поскольку образ ОС расчитан на минимальный размер SD-карты, то при
установке на носитель превосходящий этот размер образуется неразмеченное
пространство. Изначально Raspbian содержит систему которая первом включении устройства расширяет раздел "rootfs", а при последующем включении расширяет
файловую систему раздела "rootfs".

В данном дистрибутиве раздел "rootfs" не является последним на диске, поэтому
его расширение невозможно. Вместо этого осуществляется расширение раздела "btrfs",
содержащего домашнюю директорию.

Для расширения раздела "btrfs" при первом включении:

* Копируется файл "resize_home_once" в директорию _"/etc/init.d"_
* Изменяется команда "init" в файле "cmdline.txt":
```
init=/usr/lib/home_resize.sh
```

Для расширения файловой системы раздера "btrfs" при последующем включении:

* Копируется файл "/home_resize.sh" в директорию _"/usr/lib/"_
* Отключается служба расширения "rootfs"
```
systemctl disable resize2fs_once
```
* Включается служба расширения "btrfs"
```
systemctl enable resize_home_once
```